<?php
/**
 * @file
 * Contains all related outcomes resource entity functions.
 * Entity views are found here.
 */

/**
 * Save a Resource.
 *
 * @param object $entity
 *   Resource entity
 */
function lti_tool_provider_outcomes_resource_save(&$entity) {
  return entity_get_controller('lti_tool_provider_outcomes_resource')->save($entity);
}

/**
 * Delete A Resource.
 *
 * @param object $entity
 *   Resource entity
 */
function lti_tool_provider_outcomes_resource_delete($entity) {
  entity_get_controller('lti_tool_provider_outcomes_resource')->delete($entity);
}

/**
 * Get the URL to view a Outcome record.
 *
 * @param object $resource
 *   Resource entity
 * @return array
 *   URI array
 */
function lti_tool_provider_outcomes_resource_uri($resource) {
  return array(
    'path' => 'admin/config/lti-tool-provider/outcomes-resource/view/' . $resource->id, 
  );
}
/**
 * Load a Resource Entity.
 *
 * @param int $id
 *   Resource entity id
 * @param boolean $reset
 *   Boolean for reset option
 * @return object
 *   Resource entity
 */
function lti_tool_provider_outcomes_resource_load($id = NULL, $reset = FALSE) {
  $ids = (isset($id) ? array($id) : array());
  $obj = lti_tool_provider_outcomes_resource_load_multiple($ids, $reset);
  return $obj ? reset($obj) : FALSE;
}

/**
 * Load mutiple Resource Entities.
 *
 * @param int $ids
 *   Array of ids
 * @param array $conditions
 *   Conditions for loading
 * @param boolean $reset
 *   Boolean for reset option
 * @return array
 *   Array of resource entities
 */
function lti_tool_provider_outcomes_resource_load_multiple($ids = FALSE, $conditions = array(), $reset = FALSE) {
  return entity_load('lti_tool_provider_outcomes_resource', $ids, $conditions, $reset);
}


/**
 * Theme for Grades Mapping Form.
 *
 * @param array $variables
 *   Theme variables
 *
 * @return array
 *   Themed Form
 */
function theme_lti_tool_provider_outcomes_resource_manage_form($variables) {
  $form = $variables['form'];
  $output = '';
  if (isset($_SESSION['lti_tool_provider_context_info'])) {
    $output .= drupal_render($form['title']);
    $output .= drupal_render($form['context']);
    $records = isset($form['records']['#value']) ? $form['records']['#value'] : NULL;
    if (isset($records)) {
      $counter = 1;
      $rows = array();
      foreach ($records as $record) {
        $rows[] = array(
          array('data' => $counter ),
          array('data' => drupal_render($form['row_' . $counter][$record -> lti_tool_provider_outcomes_resource_id . '_title'])),
          array('data' => drupal_render($form['row_' . $counter][$record -> lti_tool_provider_outcomes_resource_id . '_datatype_select']) ),
          array('data' => drupal_render($form['row_' . $counter][$record -> lti_tool_provider_outcomes_resource_id . '_data_created']) ),
          array('data' => drupal_render($form['row_' . $counter][$record -> lti_tool_provider_outcomes_resource_id . '_operations']) ),
        );
        $a = drupal_render($form['row_' . $counter][$record -> lti_tool_provider_outcomes_resource_id . '_datatype_container_start']);
        $b = drupal_render($form['row_' . $counter][$record -> lti_tool_provider_outcomes_resource_id . '_datatype_select']);
        $c = drupal_render($form['row_' . $counter][$record -> lti_tool_provider_outcomes_resource_id . '_datatype_container_end']);
        dpm($a, 'a' );
        dpm($b, 'b' );
        dpm($c, 'c' );
        $counter ++;
      }
      $header = array(
        t('No'),
        t('Resource Title'),
        t('Score Datatype'),
        t('Date Created'),
        t('Operations'),
      );
      $output .= theme('table', array('header' => $header, 'rows' => $rows));
    }
    else {
      $output .= drupal_render($form['message']);
    }
  }
  else {
    $output .= drupal_render($form['message']);
  }

  $output .= drupal_render_children($form);
  return $output;
}
/**
 * Submit handler for the Resource form.
 *
 * @param array $form
 *   Form array.
 * @param array $form_state
 *   Form state array.
 */
function lti_tool_provider_outcomes_resource_manage_form_validate($form, &$form_state) {
  
}
/**
 * Form for confirming changes to resource datatypes
 *
 * @param array $form
 *   Form array
 * @param array $form_state
 *   Form state array
 */
function lti_tool_provider_outcomes_resource_confirm_change_form($form, &$form_state) {
  $ids = $_GET['ids'];
  $datatype_selection = $_GET['datatypes'];
  $base_numbers = $_GET['base_numbers'];
  $message = 'This action cannot be undone. <br/>';
  $ids_array = explode(',',  $ids);
  $datatype_selected_array = explode(',',  $datatype_selection);
  $base_numbers_array = explode(',',  $base_numbers);
  $counter = 0;
  $affected_resource = array();
  foreach ($ids_array as $id) {
    $resource = lti_tool_provider_outcomes_resource_load($id);
    $affected_outcomes = lti_tool_provider_outcomes_get_affected_outcomes($resource);
    $datatype_arr = lti_tool_provider_outcomes_datatype_array($resource -> lti_tool_provider_outcomes_resource_resultvalue_sourcedids);
    $selected_datatype = $datatype_arr[$datatype_selected_array[$counter]];
//     dpm($base_numbers_array);
//     dpm($base_no);
    $base_no = $base_numbers_array[$counter];
    $counter++;
    $str = 'Changing resource <b>' . $resource -> lti_tool_provider_outcomes_resource_resource_link_title . '</b> datatype to <b>' . $selected_datatype . '</b> will affect <b>' . (isset($affected_outcomes) ? count($affected_outcomes) : 0) . '</b> of outcomes record(s)! </br><br/>';
    $message .= $str;
    $form['row_' . $counter][$resource -> lti_tool_provider_outcomes_resource_id . '_selected_datatype'] = array(
      '#type' => 'value',
      '#value' => $selected_datatype,
    );
    $form['row_' . $counter][$resource -> lti_tool_provider_outcomes_resource_id . '_affected_outcomes'] = array(
      '#type' => 'value',
      '#value' => $affected_outcomes,
    );
    $form['row_' . $counter][$resource -> lti_tool_provider_outcomes_resource_id . '_base_value'] = array(
      '#type' => 'value',
      '#value' => (strcasecmp($base_no, 'EMPTY') == 0) ? NULL : $base_no,
    );
    $affected_resource[] = $resource;
  }
  $form['affected_resource'] = array(
    '#type' => 'value',
    '#value' => $affected_resource,
  );
  $form['return_url'] = array(
    '#type' => 'value',
    '#value' => isset($_GET['return_url']) ? $_GET['return_url'] : '',
  );
  return confirm_form($form,
    t('Are you sure you want to make changes to the resource record(s)?'),
    $_SERVER['HTTP_REFERER'],
    t($message),
    t('Change'),
    t('Cancel'));
}
/**
 * Submit handler for confirming resource changes.
 *
 * @param array $form
 *   Form array.
 * @param array $form_state
 *   Form state array.
 */
function lti_tool_provider_outcomes_resource_confirm_change_form_submit($form, &$form_state) {
  $affected_resource = $form_state['values']['affected_resource'];
  foreach ($affected_resource as $resource) {
    $datatype = $form_state['values'][$resource -> lti_tool_provider_outcomes_resource_id . '_selected_datatype'];
    $base_no = $form_state['values'][$resource -> lti_tool_provider_outcomes_resource_id . '_base_value'];
    $affected_outcomes = $form_state['values'][$resource -> lti_tool_provider_outcomes_resource_id . '_affected_outcomes'];
    // set all affected outcomes score to zero
    foreach ($affected_outcomes as $outcome) {
      $outcome -> lti_tool_provider_outcomes_score = lti_tool_provider_outcomes_get_datatype_default_value($datatype);
      $outcome -> lti_tool_provider_outcomes_last_updated = NULL;
      lti_tool_provider_outcomes_save($outcome);
    }
    $resource -> lti_tool_provider_outcomes_resource_score_datatype = $datatype;
    $resource -> lti_tool_provider_outcomes_resource_score_datatype_base_value = $base_no;
    $resource -> lti_tool_provider_outcomes_resource_timestamp_last_updated = REQUEST_TIME;
    lti_tool_provider_outcomes_resource_save($resource);
  }
  drupal_set_message(t('Configurations saved'));
  $form_state['redirect'] = $form_state['values']['return_url'];
}