<?php

/**
 * @file
 * LTI Tool Provider Attributes hook implementations and support functions.
 */

use Drupal\Core\Entity\EntityStorageException;
use Drupal\user\Entity\User;

/**
 * Implements hook_lti_tool_provider_authenticated().
 * @param User $user
 * @param array $context
 */
function lti_tool_provider_attributes_lti_tool_provider_authenticated(User $user, array $context)
{
    $mapped_attributes = Drupal::config('lti_tool_provider_attributes.settings')->get('mapped_attributes');

    if ($user->getUsername() === 'ltiuser') {
        return;
    }

    if (!count($mapped_attributes)) {
        return;
    }

    foreach ($mapped_attributes as $user_attribute => $lti_attribute) {
        if (isset($context[$mapped_attributes[$user_attribute]]) && !empty($context[$mapped_attributes[$user_attribute]])) {
            $user->set($user_attribute, $context[$mapped_attributes[$user_attribute]]);
        }
    }

    try {
        $user->save();
    }
    catch (EntityStorageException $e) {
        Drupal::logger('lti_tool_provider')->error(
            'Error saving LTI user attributes.'
        );
    }
}
